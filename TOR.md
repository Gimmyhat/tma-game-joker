# Техническое задание (TOR)
**Проект**: TMA Joker Game
**Заказчик**: hello-leonid
**Исполнитель**: [Имя Исполнителя]
**Версия**: v1.3 (PHASE 2 - DOCUMENTATION COMPLETE)
**Дата**: 2026-02-04
**Бюджет**: 200К
**Срок разработки**: 8-10 недель (уточнить по итогам оценки)

> Этот документ — единый источник правды по требованиям. Любые изменения фиксируются в TOR_CHANGELOG.md.
> Открытые неоднозначности ведутся в OPEN_QUESTIONS.md.
> **Техническая спецификация** (схемы БД, API, State Machines) вынесена в [TECH_SPEC.md](docs/TECH_SPEC.md).

***

## 1. Цель и краткое описание

### 1.1 Термины и определения

| Термин | Определение |
|--------|-------------|
| **CJ (Crypto Jokers)** | Внутренняя валюта платформы. Используется для ставок и призов. |
| **House Edge** | Комиссия платформы (%) с банкролла платных столов. |
| **Ledger** | Журнал всех финансовых операций с гарантией целостности. |
| **Пулька** | Группа из нескольких раздач (этап игры). |
| **Тузование** | Автоматический выбор первого раздающего (кому выпал первый Туз). |
| **Взятка** | Одна "рука" в раздаче; карты 4-х игроков. |
| **Штанга** | Штраф за заказ ≥1 взяток при итоговых 0 взятках. |
| **Премия** | Бонус в конце пульки для игрока, взявшего "своё" все раздачи. |

### 1.2 Цель проекта
- Разработка карточной игры "Джокер" (вариант "Популярный") в формате Telegram Mini App (TMA) для игры 4-х пользователей.
- **Краткое описание**: Реализация многопользовательской карточной игры на 4 человека по правилам "Джокер" (24 раздачи, 36 карт). Игра включает сложную систему ставок (заказов), механику козырей/джокеров, таблицу очков (пулька), современную панель администратора, турнирную систему и экономику.
- **Пользователи/роли**: Игрок (User), Администратор (Admin), Супер-Администратор (Super-Admin), Бот (AI/Filler).
- **Ожидаемая нагрузка**: 100-200 одновременных игр (400-800 активных WebSocket-соединений).

## 2. Объём работ (Scope)

### 2.1 Что входит в проект (In scope)
- **Клиентская часть (Frontend)**: Telegram Mini App с функциональным дизайном (Wireframe/Basic UI). 
- **Серверная часть (Backend)**: Игровая логика, WebSocket, Экономическое ядро (Ledger), Турнирный движок.
- **Админ-панель**: Интерактивная панель (TailAdmin) с Live-управлением столами ("God Mode").
- **Игровая механика**: Полная реализация правил "Joker", включая все кейсы джокера и подсчет очков.
- **Экономика**: Внутренняя валюта (CJ), кошелек, история транзакций, модерация заявок на вывод.
- **Турниры**: Система проведения турниров (сетка, призовые, расписание, авто-заполнение ботами).
- **Мета-фичи**: Таблица лидеров, Партнерская программа, Система заданий.
- **Боты (Rule-based AI)**: Эвристические алгоритмы для двух уровней сложности: "Standard" (филлер/обучение) и "Killer" (максимизация победы, минимум ошибок). Не ML.

### 2.2 Что НЕ входит в проект (Out of scope)
- Нативные мобильные приложения (iOS, Android).
- **Финальный Production Design** (Pixel-perfect, сложные 3D анимации, арт-дирекшн). Реализуется чистый, функциональный UI для тестирования механик.
- **Интеграция внешних платежных шлюзов** (Fiat/Crypto эквайринг). Реализуются только моки/стабы и UI заявок.
- **Web3/Blockchain интеграция**: Реальный коннект кошелька (TON Connect) и транзакции в блокчейне.
- Умные боты (AI с продвинутой стратегией, ML).

> Всё, что не перечислено в "In scope" и/или в требованиях ниже, считается вне объёма работ и оформляется как Change Request.

## 3. Функциональные требования

> Формат: 1 требование = 1 смысл. У каждого REQ есть критерии приёмки (pass/fail).

### Модуль 1: Игровой цикл (Game Loop)
- **REQ-1**: Поддержка матча на 4-х игроков длительностью 24 раздачи.
  - **Приоритет**: MUST
  - **AC1**: Реализованы 4 этапа (пульки): по 1 карте (1-8), по 9 карт, по 1 карте (8-1), по 9 карт.
  - **AC2**: Реализована механика "Тузования" для автоматического выбора первого раздающего.
  - **AC3**: Реализован переход хода и смена раздающего по часовой стрелке.
  - **AC4**: Первый ход в раздаче делает игрок по часовой стрелке от раздающего; далее ход начинает игрок, взявший взятку.

### Модуль 2: Механика раздачи и ставок
- **REQ-2**: Система заказов (ставок) взяток.
  - **Приоритет**: MUST
  - **AC1**: Игроки по очереди делают заказ (кол-во взяток).
  - **AC2**: Раздающий делает заказ последним.
  - **AC3**: Реализовано правило "сумма заказов не равна длине раздачи" (последний игрок ограничен в выборе; если сумма уже равна длине, запрещён заказ 0).
  - **AC4**: Учет карт: колода 36 карт (без черных шестерок, +2 джокера).

### Модуль 3: Логика карт и Джокера
  - **REQ-3**: Валидация ходов и механика Джокера.
    - **Приоритет**: MUST
    - **AC1**: Обязательность игры в масть -> козырь -> сброс.
  - **AC2**: Старшинство карт от шестёрки до туза; все масти равны, козырная масть старше остальных.
  - **AC3**: Джокер может быть сыгран в любой момент, даже при наличии масти или козыря.
  - **AC4**: Джокер при ведении: режимы "Высшая карта" (High) и "Низшая карта" (Low) с выбором масти.
  - **AC5**: При High остальные обязаны сыграть старшую карту заявленной масти; при Low — любую карту заявленной масти.
  - **AC6**: Если джокер не первой картой, доступны режимы "Сверху" (Top) и "Снизу" (Bottom).
  - **AC7**: Выбор козыря в раздачах по 9 карт выполняет игрок по часовой стрелке от раздающего (или выбирает игру без козыря).
  - **AC8**: Если козырной картой выпал Джокер — игра идет без козыря.
  - **AC9**: Если два Джокера с опцией "Сверху" — побеждает последний.
  - **AC10**: Если у игрока нет масти при ответе на High/Low, он обязан бить козырем (если есть); козырь выше джокера в этом сценарии.

### Модуль 4: Подсчет очков и таблица
- **REQ-4**: Ведение листа счета (Table scoring).
  - **Приоритет**: MUST
  - **AC1**: Если заказ = взятки и заказ < длины раздачи, начисление `50 × bet + 50`.
  - **AC2**: Если заказ = взятки = длина раздачи, начисление `100 × roundLength`.
  - **AC3**: Если заказ ≠ взятки, начисление `10 × tricks`.
  - **AC4**: Начисление штрафа "Штанга" (заказал >1, взял 0) = **-200 очков**.
  - **AC5**: Расчет "Премии" в конце пульки (выход на премию, списание очков у соседа).
  - **AC6**: Порядок в листе счёта: первый сдающий ставится 4-м, далее по часовой стрелке; 1-й и 4-й считаются рядом.
  - **AC7**: Отображение итоговой таблицы после каждой пульки и финал игры.

### Модуль 5: UI/UX (Functional MVP)
- **REQ-5**: Функциональный интерфейс игры (без финального дизайна).
  - **Приоритет**: MUST
  - **AC1**: **Лобби** содержит основные разделы: Баланс, Профиль, Настройки, Партнерка, Задания, Рейтинг, Столы, Турниры.
  - **AC2**: **Игровой стол**: системный лог событий, область реплик игроков (пресеты), меню (выйти/настройки/вернуться), лист счета, кнопка «последняя взятка» (просмотр при удержании), выбор взятки с доступными значениями.
  - **AC3**: **Экран конца игры**: Победа/Поражение, место, приз (если платный стол), визуализация мест (пьедестал/медали), кнопка «Посмотреть лист счета», возврат в лобби.
  - **AC4**: Анимации карт (раздача, полет взятки) реализованы технически (Framer Motion), но без сложных визуальных эффектов.
  - **AC5**: Адаптивность под мобильные устройства (Telegram WebApp Safe Areas).
  - **AC6**: **Chat & Communication**: Лог событий стола (System Log). Общение игроков только через пресеты (Emojis/Replicas). Free-text чат отключен.

### Модуль 6: Лобби и Матчмейкинг
- **REQ-6**: Система поиска и создания игр.
  - **Приоритет**: MUST
  - **AC1**: **Table Types**: `Training` (vs Bots), `Free` (PvP Practice, без рейтинга), `Paid` (ставки CJ, влияет на рейтинг).
  - **AC2**: **Bet Tiers**: 3 фиксированных уровня ставок для платных столов (по умолчанию 500/1000/1500 CJ), значения редактируются админом.
  - **AC3**: **Lobby UX**: отображаются блоки Training, Free и 3 платных стола с ценой входа и призовым фондом.
  - **AC4**: **Seating UX**: если игрок подключился первым, видит пустые места; при недоборе игроков в течение N секунд — автозаполнение ботами.
  - **AC5**: Игрок может создать комнату и получить ссылку-приглашение.
  - **AC6**: Очередь (Matchmaking) и бот-филл через 60 сек.

### Модуль 7: Сетевая устойчивость (Reconnect)
- **REQ-7**: Восстановление сессии при обрыве соединения.
  - **Приоритет**: MUST
  - **AC1**: При разрыве WebSocket игрок имеет 30 сек на переподключение.
  - **AC2**: При переподключении игрок получает полный `game_state` и продолжает игру.
  - **AC3**: Если игрок не переподключился за 30 сек — его заменяет бот.
  - **AC4**: При перезагрузке страницы (F5) игрок автоматически возвращается в активную игру.

### Модуль 8: Экономика (Economy Layer)
- **REQ-8**: Система транзакций и балансов (Внутренний Ledger).
  - **Приоритет**: CRITICAL
  - **AC1**: **Ledger**: История всех изменений баланса. Статусы: `PENDING`, `SUCCESS`, `FAILED`, `CANCELLED`.
  - **AC2**: **Withdrawal**: Заявка на вывод создается в статусе `PENDING`, требует подтверждения админа.
  - **AC3**: **Idempotency**: Защита от дублей через `idempotency_key` на всех финансовых методах.
  - **AC4**: **Race Protection**: Блокировка row в БД при транзакции или атомарные update-запросы (`balance = balance - X`).
  - **AC5**: Типы операций: Deposit (Mock), Withdraw, Bet_Hold (холд ставки), Bet_Release, Win_Payout, Referral_Bonus, Refund (возврат), TaskReward (награда).
  - **AC6**: Пользователь видит понятные статусы вывода: `На проверке`, `Выплачено`, `Отклонено` (с причиной).
  - **AC7**: **History UI**: Таблица транзакций пользователя содержит: ID, Дата, Тип, Сумма, Валюта, Баланс после, Статус, Комментарий. Поддержка сортировки, фильтров и пагинации.
  - **AC8**: **Deposit/Withdraw UX (Mock)**: выбор способа, ввод суммы, подтверждение. Внешняя платежная интеграция не требуется (только UI/стаб).

### Модуль 9: Панель Администратора
- **REQ-9**: Live-Admin Panel (Ref: tailadmin.com).
  - **Приоритет**: HIGH
  - **AC1**: **Auth**: Авторизация администратора по логину и паролю.
  - **AC2**: **Users**: Список пользователей с поддержкой мульти-сортировки и сложных фильтров (Like, Range, Enums, логика AND/OR). Детальная карточка:
    - Инфо: ID, дата регистрации/обновления, баланс (депозиты, выведено, прибыль).
    - Реферальные связи: код, спонсор (изменяемый), список рефералов.
    - Статистика: игры/турниры, рейтинг, занятые места (1–4 в платных/бесплатных столах и турнирах).
    - Онлайн: активные столы/турниры с переходом к управлению.
    - Изменяемые поля: никнейм, аватар, страна, статус, флаг “ИИ‑бот”.
    - Фильтры: по одному/нескольким столам и турнирам.
    - Партнерская программа: отдельный список рефералов, изменение спонсора, отключение от партнерки.
  - **AC3**: **Financial Transactions**: Полный журнал финансовых операций:
    - Поля: сумма, реальная сумма, валюта, тип операции, инициатор, получатель, комментарий.
    - Фильтры: по столам/турнирам/пользователям, типу игрока, типу операции.
    - Действия: добавление/списание баланса с комментарием.
    - Модерация заявок на вывод: Approve/Reject с комментарием.
    - Агрегация: отображение суммы по найденным записям.
  - **AC4**: **Event Log**: Журнал событий (регистрация, столы, турниры) с полями:
    - ID, время, игрок, тип игрока, тип действия, контекст, ID стола/турнира, детали.
    - Фильтры: по игроку, типу действия, столу/турниру, дате/времени.
  - **AC5**: **Audit Log & Analytics**:
    - Полный лог всех операций (пользователи, игры, турниры, транзакции) с фильтрами.
    - Аналитика: общий оборот, доход платформы (комиссии со столов/турниров/платежных систем), доход по партнерской программе.
  - **AC6**: **Live Game ("God Mode")**:
    - Подключение к столу через сокет, просмотр карт и всей колоды.
    - Ручное перемещение карт в колоде, ручная раздача, случайное перемешивание.
    - Подмена карт на руках (Card Swap - Debug/Cheat).
    - Включение "Killer Mode" для бота.
    - **Security**: Доступ к God Mode только у Super-Admin. Любое действие в этом режиме пишет критический лог в Audit Log.
  - **AC7**: **Tables Management**: Список/деталь столов с полями:
    - Тип стола, стоимость входа, кол-во игроков, лидер и отрыв, маржа, выручка, призовой фонд.
    - Номер раздачи, время создания/старта/завершения, время на ход, статус, ссылка на турнир.
    - Просмотр стола от лица пользователя.
  - **AC8**: **Tournaments Management**:
    - Создание/изменение/список турниров с полями: тип, статус, участники (план/факт), стоимость входа, выручка, призовые места и суммы, призовой фонд, время на ход, даты регистрации/старта.
    - Управление ботами: интервалы автодобавления, лимиты, ручное добавление.
    - Действия: отмена/перенос старта, управление участниками, просмотр столов турнира.
    - Статусы публикации/прогресса: не опубликован, регистрация, начат (этапы), отменён, завершен.
  - **AC9**: **Tasks Management**: Список/создание/изменение заданий, модерация выполненных (approve/reject), поля: ID, название, short/long описание, даты, статус публикации.
  - **AC10**: **Notifications**: CRUD уведомлений через Telegram‑бота:
    - Поля: ID, тип (общие/маркетинг/турнир), описание, дата создания/изменения, время отправки, отправка “сейчас”.
  - **AC11**: **Global Settings**:
    - Платные столы: 3 типа (стоимость входа, призовой фонд, время на ход, max bots).
    - Бесплатные столы: с ботами / с пользователями (время на ход).
    - Таймер подсадки бота в стол.
    - House Edge (%) — комиссия платформы.
    - Referral Bonus (%) — процент от House Edge для рефереров.
  - **AC12**: **Filtering & Sorting**:
    - Мульти-сортировка (по 2+ колонкам одновременно) на всех списках.
    - Сложные фильтры с логикой AND/OR.
    - Типы фильтров: Like (текст), Range (даты, числа), Enum (статусы), Boolean.

### Модуль 10: Турниры
- **REQ-10**: Система проведения турниров.
  - **Приоритет**: HIGH
  - **AC1**: **Restrictions**: Игрок может быть записан только в 1 активный турнир. Поддержка сеток на 16, 32, 64 игрока.
  - **AC2**: **Lifecycle**: `ANNOUNCED` -> `REGISTRATION` -> `STARTED` (Stages) -> `FINISHED` -> `ARCHIVED`.
  - **AC3**: **Lobby List**: Список турниров с данными (тип, время, участники, места, стоимость, призовой фонд, призовые места). Бесплатный турнир всегда первым; платные сортируются по оставшимся местам (по возрастанию).
  - **AC4**: **Tournament Lobby**: Экран турнира с деталями (призы по местам, время на ход) и кнопками “Детали турнира” / “Таблица турнира” / “Регистрация”.
  - **AC5**: **Registration UX**: Подтверждение правил и оплаты, статус “Вы зарегистрированы”.
    - В лобби турнира доступна кнопка выхода; если турнир не начат — выход разрешен с предупреждением о последствиях неявки.
  - **AC6**: **Reminders**: Напоминания через Telegram‑бота за N дней и за N минут до старта.
  - **AC7**: **Bracket UI**: Визуализация этапов и таблиц:
    - Показ этапов, списков столов и слотов участников.
    - Выделение текущего стола игрока.
    - Возможность открыть лист счета завершённого стола.
  - **AC8**: **Stage Flow**: Автоматический перевод победителей на следующий стол, ожидание завершения других столов. No‑Show: если игрок не пришёл за N секунд — замена ботом. Предупреждение при выходе (невозвратность).
    - При закрытии приложения/выходе игрок заменяется ботом; возвращение возможно в рамках механики reconnect (REQ‑7).
  - **AC9**: **Finish**: Итоговое место, сообщение о победе/поражении, начисление выигрыша/баланса.
  - **AC10**: **Prize Distribution**: Настраиваемое распределение (e.g. 50%/30%/20% или Winner Takes All). Поддержка 1-4 призовых мест.

### Модуль 11: Мета-фичи
- **REQ-11**: Социальные механики и Профиль.
  - **Приоритет**: MEDIUM
  - **AC1**: **Rating Formula**: Очки рейтинга = Победы в платных столах + Победы в столах платных турниров + Победы в бесплатных турнирах (только 1‑е место).
  - **AC2**: **Affilliate**: Реферальный код, список рефералов, начисление % от House Edge. UX: Кнопка "Скопировать ссылку" и "Поделиться". Статистика: Доход, кол-во приглашенных, ссылка на транзакции с начислениями.
  - **AC3**: **User Profile**: Смена аватара (из пака собак), Выбор флага страны, отображение своей позиции в рейтинге и переход в общий рейтинг, **Wallet Mock‑Flow**:
    - Кнопка “Привязать кошелёк”, сообщение “Открыть wallet в Telegram”.
    - Mock‑подтверждение доступа (код).
    - Отображение адреса кошелька и ссылки на последние операции (фильтр транзакций).
  - **AC4**: **Settings**: Громкость, Язык (RU), Вкл/Выкл сообщений чата.
  - **AC5**: **Onboarding**: Старт через Telegram-бота, захват Referrer ID, приветственное сообщение.
  - **AC6**: **Notifications**: Системные уведомления в чат (старт турнира, выплата). Дублирование через Telegram-бота (если WebApp закрыт).
  - **AC7**: **Tasks**: Списки заданий, детали (название, описание, вознаграждение, даты начала/окончания), статусы (Active/Review/Done), ручная/авто проверка.
  - **AC8**: **Leaderboard UI**: Таблица рейтинга с колонками (Место, Никнейм, Флаг, Сыграно, Очки рейтинга, 1/2/3 места).

## 4. Нефункциональные требования

- **Производительность**:
  - Поддержка 100-200 одновременных игр (400-800 WebSocket-соединений).
  - Задержка обработки хода: < 100ms.

- **Безопасность**:
  - Валидация Telegram `initData` (HMAC-SHA256).
  - Server authoritative: клиент не может подделать состояние игры.
  - **Финансовая безопасность**: Идемпотентность транзакций, логгирование всех финансовых операций.

- **Совместимость**:
  - Telegram WebApp (iOS, Android, Desktop).
  - Браузеры: Chrome, Safari, Firefox (последние 2 версии).

- **Таймауты**:
  - Таймаут на ход: 30 секунд (при истечении — автоход ботом).
  - Таймаут на реконнект: 30 секунд.
  - Таймаут на заполнение ботами: 60 секунд.

- **Качество кода**:
  - Unit-тесты: покрытие критических правил ≥ 80%.
  - Типизация: TypeScript strict mode.

## 5. Этапы работ и приёмка

> Этапы обновлены с учетом Phase 2 (Complete MVP).

### Этап 1: Core & Network (Завершен в v0.2)
- **Результат**: Игровой движок, WebSocket, Reconnect.
- **Статус**: Готов к интеграции.

### Этап 2: Экономика и Админка (3 недели)
- **Результат**: Ledger, Admin Panel (TailAdmin), User Profile, Tasks.
- **Критерии приёмки**:
  - Админ видит пользователей, столы и транзакции в современном UI.
  - Работает начисление/списание средств.
  - Пользователь видит баланс и историю.

### Этап 3: Турниры и Мета (3 недели)
- **Результат**: Турнирный движок, UI Турниров, Рефералка, Лидерборд.
- **Критерии приёмки**:
  - Успешное проведение турнира на 16 игроков (с ботами).
  - Корректное распределение призов.
  - Отображение глобального рейтинга.

### Этап 4: Интеграция и Полировка (2 недели)
- **Результат**: Готовый продукт (Golden Master).
- **Критерии приёмки**:
  - **E2E**: тестирование всех сценариев (Игра -> Турнир -> Админка).
  - **UI**: Реализован чистый функциональный интерфейс (согласно REQ-5), все анимации плавные.
  - **Quality**: Исправление всех P0/P1 багов.

## 6. Definition of Done (Критерии завершения проекта)

Проект считается завершенным, если:

1. ✅ **Тесты**: 50+ unit-тестов покрывают правила валидации ходов и подсчета очков.
2. ✅ **Bot-fallback**: При отключении игрока через 30 сек за него ходит бот. Игра доходит до конца.
3. ✅ **Race Conditions**: При одновременной отправке хода от двух клиентов сервер корректно обрабатывает только валидный.
4. ✅ **Reconnect**: При перезагрузке страницы игрок автоматически получает актуальный `game_state`.
5. ✅ **Партия**: Можно сыграть полную партию (24 раздачи) без критических багов.
6. ✅ **Экономика**: Балансы пользователей корректно обновляются, история транзакций прозрачна.
7. ✅ **Админка**: Администратор имеет полный контроль над системой (бан, остановка игры, просмотр логов).
8. ✅ **Турнир**: Проведен тестовый турнир с распределением призовых мест.

## 7. Изменения (Change Requests)

> Любое расширение/изменение scope, сроков или бюджета оформляется как CR.

- **CR-1 (2026-02-04)**: Добавление Admin Panel, Economy, Tournaments в Scope MVP Phase 2.

## 8. Гарантия и поддержка
- **Гарантия исправления багов**: [уточнить]
- **Поддержка после гарантии**: [уточнить]

## 9. Технологический стек (Рекомендация)

> Финальный стек согласовывается с Заказчиком.

- **Frontend**: React 18 + **Vite** + Telegram WebApp SDK + **Framer Motion**.
- **Admin**: **TailAdmin** (React/Vite) + Backend API.
- **Backend**: Node.js 20+ / NestJS 10+ / TypeScript 5+
- **Real-time**: Socket.io 4+ (fallback на Long Polling)
- **Hot Data**: Redis 7+ (состояние активных игр, TTL)
- **Cold Data**: PostgreSQL 15+ (история игр, пользователей, транзакции, JSONB).
- **DevOps**: Docker + Docker Compose, PM2

## 10. Приложения / ссылки
- **Правила**: `docs/Правила и механика игры Joker.md`
- **Макеты Figma**: [figma.com/design/9D7EzC04qqZf8sFj06lfqM/Joker](https://www.figma.com/design/9D7EzC04qqZf8sFj06lfqM/Joker?node-id=0-1&t=wa8jmuPqxner9E4w-1)
- **Техническая спецификация (ROADMAP)**: `ROADMAP.md`
