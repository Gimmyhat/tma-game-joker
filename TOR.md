# Техническое задание (TOR)
**Проект**: TMA Joker Game
**Заказчик**: hello-leonid
**Исполнитель**: [Имя Исполнителя]
**Версия**: v0.2 (DRAFT)
**Дата**: 2026-01-21
**Бюджет**: 200К
**Срок разработки**: 7-8 недель (56 дней)

> Этот документ — единый источник правды по требованиям. Любые изменения фиксируются в TOR_CHANGELOG.md.
> Открытые неоднозначности ведутся в OPEN_QUESTIONS.md.

***

## 1. Цель и краткое описание
- **Цель проекта**: Разработка карточной игры "Джокер" (вариант "Популярный") в формате Telegram Mini App (TMA) для игры 4-х пользователей.
- **Краткое описание**: Реализация многопользовательской карточной игры на 4 человека по правилам "Джокер" (24 раздачи, 36 карт). Игра включает сложную систему ставок (заказов), механику козырей/джокеров, таблицу очков (пулька) и специфические правила начисления бонусов и штрафов.
- **Пользователи/роли**: Игрок (User).
- **Ожидаемая нагрузка**: 100-200 одновременных игр (400-800 активных WebSocket-соединений).

## 2. Объём работ (Scope)

### 2.1 Что входит в проект (In scope)
- **Клиентская часть (Frontend)**: Telegram Mini App (интерфейс стола, карт, таблица счета).
- **Серверная часть (Backend)**: Игровая логика (server authoritative), WebSocket (real-time), управление состоянием матча.
- **Игровая механика**: Полная реализация правил "Joker" (вариант "Популярный").
- **Система подсчета очков**: Автоматический подсчет, ведение "пульки", расчет премий и штрафов ("штанга").
- **Лобби / Матчмейкинг**: Создание комнаты, присоединение по ссылке, очередь на игру.
- **Боты (Dumb AI)**: Замена отключившихся игроков ботами (random valid move strategy).
- **Reconnect**: Восстановление игровой сессии при обрыве соединения (критично для Telegram lifecycle на iOS).

### 2.2 Что НЕ входит в проект (Out of scope)
- Нативные мобильные приложения (iOS, Android).
- Сложная админ-панель.
- Платежные системы (интеграция покупок).
- Умные боты (AI с продвинутой стратегией).
- Таблица лидеров (Leaderboard) — требует уточнения (см. OPEN_QUESTIONS Q7).
- История игр (персистентное хранение) — требует уточнения (см. OPEN_QUESTIONS Q6).

> Всё, что не перечислено в "In scope" и/или в требованиях ниже, считается вне объёма работ и оформляется как Change Request.

## 3. Функциональные требования

> Формат: 1 требование = 1 смысл. У каждого REQ есть критерии приёмки (pass/fail).

### Модуль 1: Игровой цикл (Game Loop)
- **REQ-1**: Поддержка матча на 4-х игроков длительностью 24 раздачи.
  - **Приоритет**: MUST
  - **AC1**: Реализованы 4 этапа (пульки): по 1 карте (1-8), по 9 карт, по 1 карте (8-1), по 9 карт.
  - **AC2**: Реализована механика "Тузования" для автоматического выбора первого раздающего.
  - **AC3**: Реализован переход хода и смена раздающего по часовой стрелке.
  - **AC4**: Первый ход в раздаче делает игрок по часовой стрелке от раздающего; далее ход начинает игрок, взявший взятку.

### Модуль 2: Механика раздачи и ставок
- **REQ-2**: Система заказов (ставок) взяток.
  - **Приоритет**: MUST
  - **AC1**: Игроки по очереди делают заказ (кол-во взяток).
  - **AC2**: Раздающий делает заказ последним.
  - **AC3**: Реализовано правило "сумма заказов не равна длине раздачи" (последний игрок ограничен в выборе; если сумма уже равна длине, запрещён заказ 0).
  - **AC4**: Учет карт: колода 36 карт (без черных шестерок, +2 джокера).

### Модуль 3: Логика карт и Джокера
  - **REQ-3**: Валидация ходов и механика Джокера.
    - **Приоритет**: MUST
    - **AC1**: Обязательность игры в масть -> козырь -> сброс.
  - **AC2**: Старшинство карт от шестёрки до туза; все масти равны, козырная масть старше остальных.
  - **AC3**: Джокер может быть сыгран в любой момент, даже при наличии масти или козыря.
  - **AC4**: Джокер при ведении: режимы "Высшая карта" (High) и "Низшая карта" (Low) с выбором масти.
  - **AC5**: При High остальные обязаны сыграть старшую карту заявленной масти; при Low — любую карту заявленной масти.
  - **AC6**: Если джокер не первой картой, доступны режимы "Сверху" (Top) и "Снизу" (Bottom).
  - **AC7**: Выбор козыря в раздачах по 9 карт выполняет игрок по часовой стрелке от раздающего (или выбирает игру без козыря).
  - **AC8**: Если козырной картой выпал Джокер — игра идет без козыря.
  - **AC9**: Если два Джокера с опцией "Сверху" — побеждает последний.
  - **AC10**: Если у игрока нет масти при ответе на High/Low, он обязан бить козырем (если есть); козырь выше джокера в этом сценарии.

### Модуль 4: Подсчет очков и таблица
- **REQ-4**: Ведение листа счета (Table scoring).
  - **Приоритет**: MUST
  - **AC1**: Если заказ = взятки и заказ < длины раздачи, начисление `50 × bet + 50`.
  - **AC2**: Если заказ = взятки = длина раздачи, начисление `100 × roundLength`.
  - **AC3**: Если заказ ≠ взятки, начисление `10 × tricks`.
  - **AC4**: Начисление штрафа "Штанга" (заказал >1, взял 0) = **-200 очков**.
  - **AC5**: Расчет "Премии" в конце пульки (выход на премию, списание очков у соседа).
  - **AC6**: Порядок в листе счёта: первый сдающий ставится 4-м, далее по часовой стрелке; 1-й и 4-й считаются рядом.
  - **AC7**: Отображение итоговой таблицы после каждой пульки и финал игры.

### Модуль 5: UI/UX (TMA)
- **REQ-5**: Интерфейс игры согласно макетам Figma.
  - **Приоритет**: MUST
  - **AC1**: Отображение карт на руках и на столе.
  - **AC2**: Анимации раздачи и хода карт (базовые).
  - **AC3**: Удобный интерфейс выбора заказа и масти джокера.
  - **AC4**: Отображение таймера хода (30 сек).

### Модуль 6: Лобби и Матчмейкинг
- **REQ-6**: Система поиска и создания игр.
  - **Приоритет**: MUST
  - **AC1**: Игрок может создать комнату и получить ссылку-приглашение.
  - **AC2**: Игрок может присоединиться к комнате по ссылке.
  - **AC3**: Игрок может встать в очередь на поиск игры (matchmaking).
  - **AC4**: Если через 60 сек не набралось 4 игрока — пустые слоты заполняются ботами.

### Модуль 7: Сетевая устойчивость (Reconnect)
- **REQ-7**: Восстановление сессии при обрыве соединения.
  - **Приоритет**: MUST
  - **AC1**: При разрыве WebSocket игрок имеет 30 сек на переподключение.
  - **AC2**: При переподключении игрок получает полный `game_state` и продолжает игру.
  - **AC3**: Если игрок не переподключился за 30 сек — его заменяет бот.
  - **AC4**: При перезагрузке страницы (F5) игрок автоматически возвращается в активную игру.

## 4. Нефункциональные требования

- **Производительность**:
  - Поддержка 100-200 одновременных игр (400-800 WebSocket-соединений).
  - Задержка обработки хода: < 100ms.

- **Безопасность**:
  - Валидация Telegram `initData` (HMAC-SHA256).
  - Server authoritative: клиент не может подделать состояние игры.

- **Совместимость**:
  - Telegram WebApp (iOS, Android, Desktop).
  - Браузеры: Chrome, Safari, Firefox (последние 2 версии).

- **Таймауты**:
  - Таймаут на ход: 30 секунд (при истечении — автоход ботом).
  - Таймаут на реконнект: 30 секунд.
  - Таймаут на заполнение ботами: 60 секунд.

- **Качество кода**:
  - Unit-тесты: покрытие критических правил ≥ 80%.
  - Типизация: TypeScript strict mode.

## 5. Этапы работ и приёмка

> Для соло-разработки лучше 2–4 этапа, каждый заканчивается демонстрацией и приёмкой.

### Этап 1: Game Core (2 недели)
- **Результат**: Игровой движок (без UI).
- **Критерии приёмки**:
  - Все unit-тесты на правила проходят (50+ тестов).
  - Корректный подсчет очков, премий, штрафов.
  - Валидация ходов, механика Джокера.

### Этап 2: Network Layer (2 недели)
- **Результат**: WebSocket API, Reconnect, Bot fallback.
- **Критерии приёмки**:
  - 4 клиента могут сыграть партию через WebSocket.
  - При дисконнекте игрок заменяется ботом.
  - При реконнекте игрок возвращается в игру.

### Этап 3: Frontend (2-3 недели)
- **Результат**: Telegram Mini App (UI).
- **Критерии приёмки**:
  - Интерфейс соответствует макетам Figma.
  - Анимации карт работают.
  - Интеграция с WebSocket API.

### Этап 4: Интеграция и полировка (1 неделя)
- **Результат**: Готовый продукт.
- **Критерии приёмки**:
  - E2E тестирование (полная партия).
  - Деплой на staging.
  - Исправление критических багов.

## 6. Definition of Done (Критерии завершения проекта)

Проект считается завершенным, если:

1. ✅ **Тесты**: 50+ unit-тестов покрывают правила валидации ходов и подсчета очков.
2. ✅ **Bot-fallback**: При отключении игрока через 30 сек за него ходит бот. Игра доходит до конца.
3. ✅ **Race Conditions**: При одновременной отправке хода от двух клиентов сервер корректно обрабатывает только валидный.
4. ✅ **Reconnect**: При перезагрузке страницы игрок автоматически получает актуальный `game_state`.
5. ✅ **Партия**: Можно сыграть полную партию (24 раздачи) без критических багов.

## 7. Изменения (Change Requests)

> Любое расширение/изменение scope, сроков или бюджета оформляется как CR.

- (пусто)

## 8. Гарантия и поддержка
- **Гарантия исправления багов**: [уточнить]
- **Поддержка после гарантии**: [уточнить]

## 9. Технологический стек (Рекомендация)

> Финальный стек согласовывается с Заказчиком.

- **Frontend**: React / Next.js + Telegram WebApp SDK
- **Backend**: Node.js 20+ / NestJS 10+ / TypeScript 5+
- **Real-time**: Socket.io 4+ (fallback на Long Polling)
- **Hot Data**: Redis 7+ (состояние активных игр, TTL)
- **Cold Data**: PostgreSQL 15+ (история игр, JSONB) — если требуется
- **DevOps**: Docker + Docker Compose, PM2

## 10. Приложения / ссылки
- **Правила**: `docs/Правила и механика игры Joker.md`
- **Макеты Figma**: [figma.com/design/9D7EzC04qqZf8sFj06lfqM/Joker](https://www.figma.com/design/9D7EzC04qqZf8sFj06lfqM/Joker?node-id=0-1&t=wa8jmuPqxner9E4w-1)
- **Прототипы**: [figma.com/...](http://figma.com/design/6Rwc7F473IVA081Cyo74ts/Joker--Pavel-?node-id=27-2&p=f)
- **Техническая спецификация (ROADMAP)**: `ROADMAP.md`
