# Техническое задание (Backend-TOR)
**Проект**: TMA Joker Game  
**Заказчик**: hello-leonid  
**Исполнитель**: [Имя Исполнителя]  
**Версия**: v1.0  
**Дата**: 2026-01-21  
**Бюджет**: 150 000 ₽  
**Срок разработки**: 2 недели (14 календарных дней)

> Этот документ является самостоятельным источником истины для приёмки backend-части проекта.  
> Любые изменения фиксируются как Change Request (см. раздел 8).

***

## 1. Цель и назначение
Разработать серверную часть многопользовательской карточной игры "Joker" (вариант "Популярный") для 4 игроков, обеспечивающую игровую логику, сетевое взаимодействие, сохранение состояния и возможность аудита результата по критериям приёмки.

## 2. Объём работ (Scope)

### 2.1 Входит в работу (In scope)
1) **Game Engine (Server authoritative)**:
   - Полная реализация правил игры для 24 раздач, 4 игроков.
   - Валидация ходов, заказов, определения взятки и подсчёта очков.
2) **Real-time API**:
   - WebSocket API для игровых событий и синхронизации состояния.
   - Серверная защита от некорректных ходов и рассинхронизации.
3) **Telegram Mini App совместимость (без UI)**:
   - Валидация Telegram WebApp `initData` и идентификация пользователя.
   - Обработка сессий с учётом жизненного цикла WebApp (reconnect).
3) **Состояние игр (Hot State)**:
   - Хранение состояния активных матчей (память/Redis).
   - Восстановление состояния при реконнекте клиента.
4) **Боты (fallback)**:
   - Замена отключившихся игроков ботом с валидными ходами.
5) **История и статистика (Cold Data)**:
   - Сохранение итогов матчей и базовой статистики пользователей.
6) **Документация**:
   - Описание протокола событий/сообщений WebSocket API.
   - Инструкция запуска локально (README).

### 2.2 Не входит в работу (Out of scope)
- UI/UX, верстка, Telegram Mini App интерфейс, анимации.
- Платежные системы.
- Продвинутый AI/ML для ботов.
- Продакшн-инфраструктура, CI/CD, мониторинг (если не оговорено отдельно).
- Лидерборды (если не указаны как отдельная задача).

## 3. Источник правил
Правила игры и механика фиксируются в **Приложении A** (полный текст правил ниже).  
Приоритет источника правил: Backend-TOR (Приложение A) → Change Request.

## 4. Функциональные требования и критерии приёмки

### Модуль A: Игровой цикл
**REQ-A1**: Матч на 4 игроков, 24 раздачи, 4 пульки.  
- **AC1**: Реализованы последовательности раздач: 1–8, 9, 8–1, 9.  
- **AC2**: Автоматическое “тузование” для выбора первого сдающего.  
- **AC3**: Смена сдающего и первого хода по часовой стрелке.

### Модуль B: Заказы и раздачи
**REQ-B1**: Заказы взяток по очереди.  
- **AC1**: Последний заказ не может сделать сумму заказов равной длине раздачи.  
- **AC2**: Валидация количества карт в раздаче согласно этапу.  

### Модуль C: Логика ходов и джокера
**REQ-C1**: Валидация хода согласно масти/козырю/сбросу.  
- **AC1**: Обязательная масть → обязателен козырь → любой сброс.  
- **AC2**: Джокер может быть сыгран в любой момент.  

**REQ-C2**: Механика джокера.  
- **AC1**: При ведении взятки: режимы High/Low с выбором масти.  
- **AC2**: Не при ведении: режимы Top/Bottom.  
- **AC3**: При двух джокерах Top выигрывает последний.  
- **AC4**: Если игрок не имеет масти в ответ на High/Low, обязан бить козырем (если есть); козырь выше джокера в этом сценарии.

### Модуль D: Подсчёт очков
**REQ-D1**: Подсчёт очков по каждой раздаче и пульке.  
- **AC1**: Если заказ = взятки и заказ = длина раздачи, начисление 100 очков за каждую взятку.  
- **AC2**: Если заказ ≠ взятки, начисление 10 очков за каждую взятку.  
- **AC3**: Штраф “Штанга” = -200 очков, если заказ ≥ 1, взяток = 0.  
- **AC4**: Реализация премии и списания согласно Приложению A.  

### Модуль E: Reconnect и bot-fallback
**REQ-E1**: Реконнект игрока.  
- **AC1**: 30 секунд на переподключение.  
- **AC2**: При реконнекте отправляется полный `game_state`.  
- **AC3**: Если таймаут истёк — игрок заменяется ботом.  

### Модуль F: История и статистика
**REQ-F1**: Сохранение итогов матчей.  
- **AC1**: Фиксация итоговых очков и победителя.  
- **AC2**: Привязка результата к идентификатору пользователя Telegram.  

## 5. Нефункциональные требования
- **Производительность**: 100–200 одновременных матчей, latency обработки хода < 100 мс (best effort, в локальных/стейджинг условиях без сетевой перегрузки).  
- **Безопасность**: проверка Telegram `initData` (HMAC-SHA256), сервер авторитарный.  
- **Надёжность**: защита от повторных и конфликтующих ходов (race conditions).  

## 6. Deliverables (артефакты сдачи)
1) Исходный код backend (репозиторий).  
2) Документация WebSocket API (события, payload, коды ошибок).  
3) Инструкция запуска (README).  
4) Скрипты или конфигурация для локального запуска (Docker Compose или эквивалент).  
5) Набор unit-тестов на критические правила (минимум 30 тестов).

## 7. Приёмка и Definition of Done
Работа считается выполненной при одновременном выполнении:
1) Все функциональные требования (REQ-A…F) подтверждены демонстрацией и тестами.  
2) 4 клиента могут сыграть полную партию (24 раздачи) через WebSocket API.  
3) Реконнект и bot-fallback работают по правилам.  
4) Итоги матчей и статистика сохраняются.  
5) Заказчик письменно подтвердил приёмку (в чате kwork.ru).

## 8. Change Request (изменения)
Любое изменение scope/сроков/бюджета/правил оформляется письменно в чате kwork.ru.  
Изменение считается утверждённым после явного подтверждения заказчиком.

## 9. Гарантия и поддержка
- **Гарантия исправления багов**: 14 календарных дней после приёмки.  
- **Поддержка после гарантии**: по отдельному соглашению.

## Приложение A. Правила и механика игры Joker (для backend)

### Базовые параметры
- 4 игрока, 24 раздачи, 4 пульки.  
- Колода: 36 карт (34 + 2 джокера), отсутствуют две чёрные шестерки.  
- Цель: набрать максимум очков.

### Раздачи
1) Пулька 1: 1–8 карт.  
2) Пулька 2: 4 раздачи по 9 карт, выбор козыря.  
3) Пулька 3: 8–1 карт.  
4) Пулька 4: 4 раздачи по 9 карт, выбор козыря.  

### Тузование
Первый сдающий определяется автоматическим “тузованием”. Очерёдность сдачи идёт по часовой стрелке.

### Заказы
- Заказы делают по очереди по часовой стрелке от сдающего, сдающий заказывает последним.  
- Сумма заказов не равна длине раздачи (последний ограничен в выборе).

### Ведение взятки и масти
- Если есть масть — обязан ходить в масть.  
- Если нет масти — обязан ходить козырем (если есть).  
- Если нет масти и козыря — любая карта.  
- Джокер может быть сыгран в любой момент.

### Джокер
При ведении взятки:  
1) **High** — выбор масти, остальные обязаны положить старшую карту масти.  
2) **Low** — выбор масти, остальные кладут любую карту масти.  

Не при ведении:  
3) **Top** — бьёт все карты, выигрывает взятку (кроме случая двух Top).  
4) **Bottom** — играет как младшая карта.

Если два джокера Top — выигрывает последний.  
Если нет масти при ответе на High/Low — обязателен козырь; козырь выше джокера в этом сценарии.

### Очки
- Если заказ = взятки и заказ = длина раздачи: 100 очков за каждую взятку.  
- Если заказ ≠ взятки: 10 очков за каждую взятку.  
- Штраф “Штанга”: если заказ ≥ 1 и взяток 0 → -200.  

### Премии
Игрок, который во всей пульке брал “своё”, получает премию:  
1) К последней взятке прибавляется максимальная взятка этой пульки (кроме последней).  
2) Максимальная взятка (кроме последней) списывается у следующего игрока по часовой стрелке.  
3) При ситуации, когда два или три игрока **рядом** вышли на премию, применяется правило последовательного снятия согласно описанию:  
   - если сосед на премии, снятие не применяется.  

### Победитель
Победитель — игрок с максимальной суммой очков. При равенстве побеждает игрок, расположенный левее в листе счёта.
